<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuroscience Term Explorer</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 為了防止寬內容破壞版面，為表格添加 table-layout: fixed */
        .results-table {
            table-layout: fixed;
            width: 100%;
        }
        .results-table td, .results-table th {
            /* 允許長單字換行 */
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- 主容器 -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- (升級) 加入 Datalist 以便共用 -->
        <datalist id="termsList"></datalist>

        <!-- 標題 -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Neuroscience Term Explorer</h1>
            <p class="text-lg text-gray-600 mt-1">簡易快速的Neurosynth搜尋頁面</p>
            <!-- 新增的介紹文字 -->
            <p class="text-md text-gray-600 mt-2 max-w-2xl">
                本工具提供一個簡潔的介面，用以查詢 Neuroscience (Neurosynth) 術語。您可以快速尋找關聯術語，或使用邏輯運算 (AND/OR/NOT) 來組合關鍵字，並即時獲取相關研究的表格。
            </p>
        </header>

        <!-- ... (flex-col 佈局) ... -->
        <div class="flex flex-col gap-8">
            <!-- 查詢控制區 (頂部) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- 1. 尋找關聯術語 -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. 尋找關聯術語</h2>
                    <p class="text-gray-600 mb-3 text-sm">輸入或從建議列表中選擇一個術語。</p>
                    
                    <!-- (升級) 
                        將 <select id="selectTerm"> 
                        改為 <input id="inputTerm" list="termsList"> 
                    -->
                    <input type="text" 
                           id="inputTerm" 
                           list="termsList"
                           class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="正在載入術語..." 
                           disabled>
                </div>

                <!-- 2. 查詢研究 -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. 查詢研究</h2>
                    <p class="text-gray-600 mb-3 text-sm">建立一個邏輯查詢 (e.g., "amygdala AND fear")。</p>
                    
                    <div class="flex flex-col sm:flex-row gap-2">
                        <!-- (升級) 
                            將 <select id="queryTerm1"> 
                            改為 <input id="queryTerm1" list="termsList"> 
                        -->
                        <input type="text" 
                               id="queryTerm1" 
                               list="termsList"
                               class="w-full sm:w-2/5 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               placeholder="(術語 1)" 
                               disabled>
                        
                        <select id="queryOperator" class="w-full sm:w-1/5 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>AND</option>
                            <option>OR</option>
                            <option>NOT</option>
                        </select>
                        
                        <!-- (升級) 
                            將 <select id="queryTerm2"> 
                            改為 <input id="queryTerm2" list="termsList"> 
                        -->
                        <input type="text" 
                               id="queryTerm2" 
                               list="termsList"
                               class="w-full sm:w-2/5 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               placeholder="(術語 2)" 
                               disabled>
                    </div>
                </div>

            </div> <!-- 查詢控制區結束 -->

            <!-- 搜尋結果區 (下方) -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col flex-1 min-h-[400px]">
                <h2 class="text-xl font-semibold text-gray-700 mb-4" id="resultsTitle">搜尋結果</h2>
                
                <!-- 載入狀態 -->
                <div id="loading" class="hidden text-center p-8">
                    <p class="text-gray-600">正在從 API 獲取資料，請稍候...</p>
                </div>
                
                <!-- 錯誤狀態 -->
                <div id="error" class="hidden bg-red-100 border border-red-300 text-red-800 rounded-lg p-4">
                    <!-- 錯誤訊息將由 JS 填入 -->
                </div>

                <!-- 結果輸出區 -->
                <div id="resultsOutput" class="flex-1">
                    <p class="text-gray-500">請在上方選擇一個操作來開始搜尋。</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-500 mt-12">
        </footer>
    </div>

    <script>
        // API 基礎 URL
        const API_BASE_URL = 'https://hpc.psy.ntu.edu.tw:5000';

        // DOM 元素 (升級)
        const inputTerm = document.getElementById('inputTerm'); // 原 selectTerm
        const queryTerm1 = document.getElementById('queryTerm1');
        const queryTerm2 = document.getElementById('queryTerm2');
        const queryOperator = document.getElementById('queryOperator');
        const termsList = document.getElementById('termsList'); // 新的 Datalist
        
        const loading = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const resultsOutput = document.getElementById('resultsOutput');
        const resultsTitle = document.getElementById('resultsTitle');

        let allTerms = []; // 儲存所有術語

        /**
         * 顯示載入狀態
         */
        function showLoading() {
            loading.classList.remove('hidden');
            resultsOutput.innerHTML = '';
            errorEl.classList.add('hidden');
        }

        /**
         * 隱藏載入狀態
         */
        function hideLoading() {
            loading.classList.add('hidden');
        }

        /**
         * 顯示錯誤訊息
         */
        function showError(message) {
            hideLoading();
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            resultsOutput.innerHTML = '<p class="text-red-600">操作失敗。</p>';
        }

        /**
         * 呼叫 API
         */
        async function fetchAPI(endpoint) {
            showLoading();
            resultsOutput.innerHTML = '';
            resultsTitle.textContent = '搜尋結果'; // 重設標題

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`API 請求失敗，狀態碼: ${response.status} (${response.statusText})`);
                }
                const data = await response.json();
                return data;
            } catch (err) {
                console.error('API 呼叫失敗:', err);
                showError(`呼叫 ${endpoint} 時發生錯誤: ${err.message}`);
                return null;
            }
        }

        /**
         * 建立關聯術語表格 (co_count, jaccard, term)
         */
        function buildAssociatedTermsTable(data) {
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 results-table';
            
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const trHead = document.createElement('tr');
            const headers = ['Term', 'Jaccard', 'Co-Count'];
            
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = h;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            
            data.forEach(item => {
                const tr = document.createElement('tr');
                const values = [
                    item.term || 'N/A',
                    item.jaccard ? parseFloat(item.jaccard).toFixed(4) : 'N/A',
                    item.co_count || 'N/A'
                ];
                
                values.forEach(val => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-700';
                    td.textContent = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            resultsOutput.appendChild(table);
        }

        /**
         * 建立研究表格 (Title, Authors, Year)
         */
        function buildStudiesTable(data) {
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 results-table';
            
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const trHead = document.createElement('tr');
            const headers = ['Title', 'Authors', 'Year']; 
            
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = h;
                if (h === 'Title') th.style.width = '50%';
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            
            data.forEach(item => {
                const tr = document.createElement('tr');
                const values = [
                    item.title || 'N/A',
                    Array.isArray(item.authors) ? item.authors.join(', ') : (item.authors || 'N/A'),
                    item.year || 'N/A'
                ];
                
                values.forEach(val => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 text-sm text-gray-700 align-top';
                    td.textContent = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            resultsOutput.appendChild(table);
        }

        /**
         * 建立 <pre> 區塊來顯示原始 JSON (備用)
         */
        function buildPre(data) {
            const pre = document.createElement('pre');
            pre.className = 'bg-gray-900 text-white p-4 rounded-lg overflow-auto text-sm';
            pre.textContent = JSON.stringify(data, null, 2);
            resultsOutput.appendChild(pre);
        }

        /**
         * 顯示 API 回應 (表格或 JSON)
         */
        function displayResult(data, title, endpoint) {
            hideLoading();
            resultsOutput.innerHTML = ''; 
            resultsOutput.className = 'bg-white border border-gray-200 rounded-lg overflow-auto h-96 max-h-[70vh]';

            const titleEl = document.createElement('h3');
            titleEl.className = 'text-lg font-semibold mb-0 p-4 pb-3 text-gray-800 sticky top-0 bg-white border-b border-gray-200 z-10';

            let dataArray = null;

            if (Array.isArray(data)) {
                dataArray = data;
            } else if (typeof data === 'object' && data !== null) {
                if (Array.isArray(data.studies)) dataArray = data.studies;
                else if (Array.isArray(data.related)) dataArray = data.related; 
                else if (Array.isArray(data.data)) dataArray = data.data;
                else if (Array.isArray(data.results)) dataArray = data.results;
            }

            if (endpoint.includes('/query')) {
                if (dataArray && dataArray.length > 0) {
                    titleEl.textContent = `${title} 共 ${dataArray.length} 篇文章`;
                    resultsOutput.appendChild(titleEl);
                    buildStudiesTable(dataArray);
                } else if (dataArray) {
                    titleEl.textContent = `${title} 共 0 篇文章`;
                    resultsOutput.appendChild(titleEl);
                    resultsOutput.innerHTML += '<p class="p-4 text-gray-600">找不到符合查詢的研究。</p>';
                } else {
                    titleEl.textContent = title; 
                    resultsOutput.appendChild(titleEl);
                    resultsOutput.innerHTML += '<p class="p-4 text-gray-600">收到了非預期的回應格式。顯示原始 JSON：</p>';
                    buildPre(data);
                }
            } else if (endpoint.includes('/terms/')) {
                titleEl.textContent = title; 
                resultsOutput.appendChild(titleEl);
                 if (dataArray && dataArray.length > 0) {
                    buildAssociatedTermsTable(dataArray);
                } else if (dataArray) {
                    resultsOutput.innerHTML += '<p class="p-4 text-gray-600">找不到關聯術語。</p>';
                } else {
                    resultsOutput.innerHTML += '<p class="p-4 text-gray-600">收到了非預期的回應格式。顯示原始 JSON：</p>';
                    buildPre(data);
                }
            } else {
                titleEl.textContent = title;
                resultsOutput.appendChild(titleEl);
                buildPre(data);
            }
        }

        /**
         * (升級) 填充 Datalist
         */
        async function populateDropdown() {
            try {
                const data = await fetchAPI('/terms');
                if (!data) throw new Error('API /terms 未返回資料');

                let termsArray = null;
                if (Array.isArray(data)) {
                    termsArray = data;
                } else if (typeof data === 'object' && data !== null) {
                    for (const key in data) {
                        if (Array.isArray(data[key])) {
                            termsArray = data[key];
                            break; 
                        }
                    }
                }

                if (!termsArray) {
                    throw new Error('API /terms 未返回陣列 (已檢查物件內部)');
                }

                allTerms = termsArray.sort(); 
                
                // (升級) 清空 datalist
                termsList.innerHTML = '';

                // (升級) 填充 datalist
                allTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term;
                    // Datalist 的 <option> 不需要 textContent
                    termsList.appendChild(option);
                });
                
                // (升級) 啟用輸入框
                inputTerm.disabled = false;
                queryTerm1.disabled = false;
                queryTerm2.disabled = false;
                
                // (升級) 更新 placeholder
                inputTerm.placeholder = '請輸入或選擇一個術語...';
                queryTerm1.placeholder = '請輸入或選擇術語 1...';
                queryTerm2.placeholder = '請輸入或選擇術語 2...';

            } catch (err) {
                console.error(err);
                showError(`無法載入術語: ${err.message}`);
                // (升級) 更新 placeholder 以顯示錯誤
                inputTerm.placeholder = '載入術語失敗';
                queryTerm1.placeholder = '載入失敗';
                queryTerm2.placeholder = '載入失敗';
            }
        }

        /**
         * (升級) 處理關聯術語的 *輸入* 變更
         */
        async function handleTermSelectChange(event) {
            const term = event.target.value;
            if (!term) {
                resultsOutput.innerHTML = '<p class="text-gray-500">請在上方選擇一個操作來開始搜尋。</p>';
                resultsTitle.textContent = '搜尋結果';
                return;
            }
            
            const endpoint = `/terms/${term}`;
            const data = await fetchAPI(endpoint);
            if (data) {
                displayResult(data, `"${term}" 的關聯術語`, endpoint);
            }
        }

        /**
         * 處理查詢建立器的變更
         */
        async function handleQueryBuilderChange() {
            // (升級) 這些 .value 現在來自 <input> 而不是 <select>
            const t1 = queryTerm1.value;
            const op = queryOperator.value;
            const t2 = queryTerm2.value;

            if (!t1 || !t2) {
                if (!t1 && !t2) {
                     resultsOutput.innerHTML = '<p class="text-gray-500">請在上方選擇一個操作來開始搜尋。</p>';
                     resultsTitle.textContent = '搜尋結果';
                }
                return;
            }
            
            const queryString = `${t1} ${op} ${t2}`;
            const endpoint = `/query/${queryString}/studies`;
            const data = await fetchAPI(endpoint);
            if (data) {
                displayResult(data, `查詢 "${queryString}" 的研究結果`, endpoint);
            }
        }


        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 載入所有術語
            populateDropdown();

            // 綁定事件監聽器 (升級)
            // 'change' 事件會在使用者從 datalist 選擇或輸入後按 Enter/點擊離開時觸發
            inputTerm.addEventListener('change', handleTermSelectChange); 
            
            queryTerm1.addEventListener('change', handleQueryBuilderChange);
            queryOperator.addEventListener('change', handleQueryBuilderChange);
            queryTerm2.addEventListener('change', handleQueryBuilderChange);
        });
    </script>
</body>
</html>


